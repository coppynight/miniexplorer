# å„¿ç«¥æ— å± AI æ¢ç´¢ä¼™ä¼´ - æŠ€æœ¯æ–¹æ¡ˆ

## 1. æ•´ä½“ç³»ç»Ÿæ¶æ„

### 1.1 æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            å®¢æˆ·ç«¯å±‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      å­©å­ç«¯ APP (iOS/Android)â”‚         å®¶é•¿ç«¯å°ç¨‹åº (å¾®ä¿¡)                â”‚
â”‚  - æ— å±æ¨¡å¼ï¼ˆé»‘å±/é”å±è¿è¡Œï¼‰   â”‚    - æ¢ç´¢æ—¶é—´çº¿                           â”‚
â”‚  - æ‹ç…§ + è¯­éŸ³è¾“å…¥            â”‚    - æ¯æ—¥æ¢ç´¢æ•…äº‹                         â”‚
â”‚  - è¯­éŸ³æ’­æ”¾                   â”‚    - äº²å­å¯¹è¯å»ºè®®                         â”‚
â”‚  - æœ¬åœ°éŸ³é¢‘ç¼“å­˜               â”‚    - è®¾ç½®ä¸æ§åˆ¶                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ç½‘å…³å±‚                                        â”‚
â”‚                     API Gateway (Kong/APISIX)                           â”‚
â”‚              - é‰´æƒè®¤è¯ - é™æµ - æ—¥å¿— - è·¯ç”±                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ä¸šåŠ¡æœåŠ¡å±‚                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç”¨æˆ·æœåŠ¡     â”‚   æ¢ç´¢æœåŠ¡     â”‚   å†…å®¹æœåŠ¡     â”‚      å®¶é•¿æœåŠ¡            â”‚
â”‚ - æ³¨å†Œ/ç™»å½•   â”‚ - ä¼šè¯ç®¡ç†     â”‚ - æ•…äº‹ç”Ÿæˆ     â”‚  - æ—¶é—´çº¿æŸ¥è¯¢            â”‚
â”‚ - è®¾å¤‡ç»‘å®š    â”‚ - äº‹ä»¶è®°å½•     â”‚ - å»ºè®®ç”Ÿæˆ     â”‚  - æ§åˆ¶è®¾ç½®              â”‚
â”‚ - å®¶åº­å…³ç³»    â”‚ - ä¸»é¢˜ç»Ÿè®¡     â”‚ - æ‘˜è¦ç”Ÿæˆ     â”‚  - æ•°æ®å¯¼å‡º/åˆ é™¤         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            AI èƒ½åŠ›å±‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Coze æ™ºèƒ½ä½“å¹³å°        â”‚           ç«å±±å¼•æ“è¯­éŸ³æœåŠ¡                 â”‚
â”‚  - ä¸»å¯¹è¯æ™ºèƒ½ä½“               â”‚    - ASR è¯­éŸ³è¯†åˆ«                         â”‚
â”‚  - æ¯æ—¥æ•…äº‹ç”Ÿæˆå·¥ä½œæµ          â”‚    - TTS è¯­éŸ³åˆæˆï¼ˆè±†åŒ…éŸ³è‰²ï¼‰              â”‚
â”‚  - è±†åŒ…è§†è§‰æ¨¡å‹ï¼ˆå›¾åƒè¯†åˆ«ï¼‰    â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ•°æ®å±‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PostgreSQL   â”‚    Redis      â”‚     OSS       â”‚    æ¶ˆæ¯é˜Ÿåˆ—              â”‚
â”‚ - ç”¨æˆ·æ•°æ®    â”‚ - ä¼šè¯ç¼“å­˜    â”‚ - å›¾ç‰‡å­˜å‚¨    â”‚  - æ•…äº‹ç”Ÿæˆä»»åŠ¡          â”‚
â”‚ - æ¢ç´¢è®°å½•    â”‚ - é™æµè®¡æ•°    â”‚ - éŸ³é¢‘å­˜å‚¨    â”‚  - æ¨é€ä»»åŠ¡              â”‚
â”‚ - é…ç½®æ•°æ®    â”‚ - çƒ­ç‚¹æ•°æ®    â”‚               â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯é€‰å‹

| å±‚çº§ | ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|------|----------|------|
| å®¢æˆ·ç«¯ | å­©å­ç«¯ APP | Flutter | è·¨å¹³å°ï¼Œæ”¯æŒåå°è¿è¡Œå’ŒéŸ³é¢‘ |
| å®¢æˆ·ç«¯ | å®¶é•¿ç«¯ | å¾®ä¿¡å°ç¨‹åº | é™ä½ä½¿ç”¨é—¨æ§›ï¼Œä¾¿äºä¼ æ’­ |
| ç½‘å…³ | API Gateway | APISIX | å¼€æºï¼Œæ€§èƒ½å¥½ï¼Œæ’ä»¶ä¸°å¯Œ |
| åç«¯ | ä¸šåŠ¡æœåŠ¡ | Go + Gin | é«˜æ€§èƒ½ï¼Œé€‚åˆ IO å¯†é›†åœºæ™¯ |
| AI | å¯¹è¯/ç”Ÿæˆ | Coze + è±†åŒ… | æŒ‰éœ€æ±‚ä¼˜å…ˆé€‰æ‹© |
| AI | è¯­éŸ³ | ç«å±±å¼•æ“ | ä¸è±†åŒ…åŒç”Ÿæ€ï¼ŒéŸ³è‰²é€‚åˆå„¿ç«¥ |
| æ•°æ®åº“ | å…³ç³»å‹ | PostgreSQL | ç¨³å®šå¯é ï¼ŒJSON æ”¯æŒå¥½ |
| ç¼“å­˜ | ç¼“å­˜ | Redis | ä¼šè¯çŠ¶æ€ã€é™æµ |
| å­˜å‚¨ | å¯¹è±¡å­˜å‚¨ | é˜¿é‡Œäº‘ OSS | å›¾ç‰‡ã€éŸ³é¢‘æ–‡ä»¶ |
| æ¶ˆæ¯ | æ¶ˆæ¯é˜Ÿåˆ— | RocketMQ | å®šæ—¶ä»»åŠ¡ã€å¼‚æ­¥å¤„ç† |

### 1.3 MVP éƒ¨ç½²æ¶æ„

MVP é˜¶æ®µé‡‡ç”¨ç®€åŒ–éƒ¨ç½²ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            é˜¿é‡Œäº‘ ECS (2å°)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     Docker Compose éƒ¨ç½²          â”‚   â”‚
â”‚  â”‚  - API æœåŠ¡                      â”‚   â”‚
â”‚  â”‚  - Redis                         â”‚   â”‚
â”‚  â”‚  - PostgreSQL                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          äº‘æœåŠ¡ï¼ˆSaaSï¼‰                  â”‚
â”‚  - Coze æ™ºèƒ½ä½“å¹³å°                       â”‚
â”‚  - ç«å±±å¼•æ“è¯­éŸ³æœåŠ¡                      â”‚
â”‚  - é˜¿é‡Œäº‘ OSS                           â”‚
â”‚  - å¾®ä¿¡å°ç¨‹åºäº‘æ‰˜ç®¡                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 2.1 å­©å­ç«¯æ¢ç´¢æµç¨‹

```mermaid
sequenceDiagram
    participant C as å­©å­ç«¯APP
    participant API as åç«¯æœåŠ¡
    participant ASR as ç«å±±ASR
    participant Coze as Cozeæ™ºèƒ½ä½“
    participant TTS as ç«å±±TTS
    participant DB as æ•°æ®åº“

    C->>C: 1. æŒ‰é”®æ‹ç…§/è¯­éŸ³è¾“å…¥
    C->>API: 2. ä¸Šä¼ å›¾ç‰‡+éŸ³é¢‘
    API->>ASR: 3. è¯­éŸ³è½¬æ–‡å­—
    ASR-->>API: 4. è¿”å›æ–‡å­—
    API->>Coze: 5. å‘é€(å›¾ç‰‡URL+æ–‡å­—+ä¼šè¯ä¸Šä¸‹æ–‡)
    Coze-->>API: 6. è¿”å›AIå›å¤æ–‡æœ¬
    API->>TTS: 7. æ–‡å­—è½¬è¯­éŸ³
    TTS-->>API: 8. è¿”å›éŸ³é¢‘URL
    API->>DB: 9. ä¿å­˜æ¢ç´¢äº‹ä»¶
    API-->>C: 10. è¿”å›éŸ³é¢‘URL
    C->>C: 11. æ’­æ”¾è¯­éŸ³
```

### 2.2 æ¯æ—¥æ¢ç´¢æ•…äº‹ç”Ÿæˆæµç¨‹

```mermaid
sequenceDiagram
    participant Cron as å®šæ—¶ä»»åŠ¡
    participant API as åç«¯æœåŠ¡
    participant Coze as Cozeå·¥ä½œæµ
    participant DB as æ•°æ®åº“
    participant Push as æ¨é€æœåŠ¡

    Cron->>API: 1. è§¦å‘æ¯æ—¥æ•…äº‹ç”Ÿæˆ(21:00)
    API->>DB: 2. æŸ¥è¯¢å½“æ—¥æ‰€æœ‰æ¢ç´¢äº‹ä»¶
    DB-->>API: 3. è¿”å›äº‹ä»¶åˆ—è¡¨
    API->>Coze: 4. è°ƒç”¨æ•…äº‹ç”Ÿæˆå·¥ä½œæµ
    Coze-->>API: 5. è¿”å›æ•…äº‹+äº²å­å»ºè®®
    API->>DB: 6. ä¿å­˜æ•…äº‹
    API->>Push: 7. æ¨é€ç»™å®¶é•¿
```

---

## 3. Coze æ™ºèƒ½ä½“è®¾è®¡

### 3.1 æ™ºèƒ½ä½“æ¶æ„

åœ¨ Coze å¹³å°åˆ›å»ºä¸¤ä¸ªæ™ºèƒ½ä½“ï¼š

| æ™ºèƒ½ä½“ | ç”¨é€” | è§¦å‘æ–¹å¼ |
|--------|------|----------|
| æ¢ç´¢ä¼™ä¼´ Bot | ä¸å­©å­å®æ—¶å¯¹è¯ | API è°ƒç”¨ |
| æ•…äº‹ç”Ÿæˆ Workflow | ç”Ÿæˆæ¯æ—¥æ¢ç´¢æ•…äº‹ | å®šæ—¶è§¦å‘ |

### 3.2 æ¢ç´¢ä¼™ä¼´ Bot è®¾è®¡

#### 3.2.1 Bot é…ç½®

```yaml
åç§°: å°æ¢æ¢ï¼ˆæ¢ç´¢ä¼™ä¼´ï¼‰
æ¨¡å‹: è±†åŒ…-pro-32k
æ¸©åº¦: 0.7
æœ€å¤§tokens: 300
å¼€å¯èƒ½åŠ›:
  - å›¾ç‰‡ç†è§£ï¼ˆè±†åŒ…è§†è§‰ï¼‰
  - è”ç½‘æœç´¢ï¼ˆå…³é—­ï¼Œä¿è¯å®‰å…¨ï¼‰
  - é•¿æœŸè®°å¿†ï¼ˆå¼€å¯ï¼Œè®°ä½å­©å­åå¥½ï¼‰
```

#### 3.2.2 System Prompt

```
# è§’è‰²å®šä¹‰
ä½ æ˜¯"å°æ¢æ¢"ï¼Œä¸€ä¸ªæ¸©æš–ã€æœ‰è¶£çš„æ¢ç´¢ä¼™ä¼´ï¼Œä¸“é—¨é™ªä¼´3-6å²çš„ä¸­å›½å°æœ‹å‹è®¤è¯†ä¸–ç•Œã€‚

# æ ¸å¿ƒåŸåˆ™
1. ã€å¯å‘ä¼˜å…ˆã€‘ä¸ç›´æ¥ç»™ç­”æ¡ˆï¼Œç”¨é—®é¢˜å¼•å¯¼å­©å­è§‚å¯Ÿå’Œæ€è€ƒ
2. ã€ç®€çŸ­è¡¨è¾¾ã€‘æ¯æ¬¡å›å¤æ§åˆ¶åœ¨50å­—ä»¥å†…ï¼Œç”¨çŸ­å¥ï¼Œè¯­é€Ÿæ…¢
3. ã€å…·ä½“ç”ŸåŠ¨ã€‘ç”¨å­©å­ç†Ÿæ‚‰çš„äº‹ç‰©åšæ¯”å–»ï¼ˆå¦‚ï¼šåƒä½ çš„å°æ‰‹ä¸€æ ·å¤§ï¼‰
4. ã€æ­£å‘é¼“åŠ±ã€‘èµèµåŠªåŠ›å’Œè§‚å¯Ÿï¼Œä¸è¯´"ä½ çœŸèªæ˜"

# å›å¤ç»“æ„ï¼ˆå¿…é¡»åŒ…å«ï¼‰
1. ç¡®è®¤æ„Ÿï¼šå¤è¿°å­©å­çœ‹åˆ°/é—®çš„å†…å®¹ï¼ˆ1å¥ï¼‰
2. å¾®çŸ¥è¯†ï¼šä¸€ä¸ªç®€å•æœ‰è¶£çš„å°çŸ¥è¯†ï¼ˆ1-2å¥ï¼‰
3. å¯å‘é—®é¢˜ï¼šä¸€ä¸ªå¼€æ”¾å¼é—®é¢˜ï¼ˆ1å¥ï¼‰
4. æ”¶æŸè¯­ï¼šé¼“åŠ±+ä¸‹æ¬¡çº¿ç´¢ï¼ˆ1å¥ï¼‰

# ä¸»é¢˜è·¯ç”±
æ ¹æ®å›¾ç‰‡/é—®é¢˜ï¼Œå½’ç±»åˆ°ä»¥ä¸‹ä¸»é¢˜å¹¶è°ƒæ•´å›å¤é£æ ¼ï¼š
- å®¶åº­ç‰©å“ï¼šå¼ºè°ƒç”¨é€”å’Œå®‰å…¨
- èº«ä½“å¥åº·ï¼šå¼ºè°ƒå¥½ä¹ æƒ¯
- å¤©æ°”è‡ªç„¶ï¼šå¼ºè°ƒè§‚å¯Ÿ
- åŠ¨æ¤ç‰©ï¼šå¼ºè°ƒç‰¹å¾å’Œç”Ÿå‘½
- ç¤¾ä¼šè§’è‰²ï¼šå¼ºè°ƒå…³è”å’Œä½“éªŒ

# è¿½é—®è§„åˆ™
ä»…åœ¨ä»¥ä¸‹æƒ…å†µè¿½é—®ï¼ˆå¦åˆ™è‡ªç„¶æ”¶æŸï¼‰ï¼š
- å­©å­ä¸»åŠ¨é—®"ä¸ºä»€ä¹ˆ/æ€ä¹ˆ/è¿˜æœ‰å‘¢"
- å­©å­å›ç­”äº†ä½ çš„é—®é¢˜
- æ”¶åˆ°æ ‡è®° [CONTINUE_SIGNAL]

# å®‰å…¨è§„åˆ™
- ä¸è®¨è®ºæš´åŠ›ã€ææ€–ã€ä¸é€‚åˆå„¿ç«¥çš„å†…å®¹
- é‡åˆ°æ•æ„Ÿå›¾ç‰‡ï¼Œæ¸©å’Œè½¬ç§»ï¼š"è¿™ä¸ªæˆ‘ä»¬ä¸‹æ¬¡å†èŠï¼Œä½ ä»Šå¤©è¿˜çœ‹åˆ°ä»€ä¹ˆæœ‰è¶£çš„ä¸œè¥¿å•¦ï¼Ÿ"
- ä¸æä¾›åŒ»ç–—å»ºè®®ï¼Œå¼•å¯¼æ‰¾å¤§äºº

# è¾“å‡ºæ ¼å¼
ç›´æ¥è¾“å‡ºè¯­éŸ³æ–‡æœ¬ï¼Œä¸è¦æœ‰è¡¨æƒ…ç¬¦å·ã€markdownæ ¼å¼ã€‚
ç”¨å£è¯­åŒ–è¡¨è¾¾ï¼Œå¯ä»¥æœ‰"å‘€ã€å‘¢ã€å“¦"ç­‰è¯­æ°”è¯ã€‚
```

#### 3.2.3 å˜é‡è®¾è®¡

| å˜é‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| child_name | string | å­©å­æ˜µç§° |
| child_age | int | å­©å­å¹´é¾„ |
| character_name | string | é€‰æ‹©çš„è§’è‰²å |
| character_style | string | è§’è‰²è¯´è¯é£æ ¼æè¿° |
| session_context | string | æœ¬è½®ä¼šè¯ä¸Šä¸‹æ–‡ |
| image_url | string | æ‹ç…§å›¾ç‰‡URL |
| user_input | string | å­©å­è¯­éŸ³è½¬æ–‡å­— |

#### 3.2.4 è§’è‰²é£æ ¼é…ç½®

```json
{
  "characters": [
    {
      "id": "xiaotantan",
      "name": "å°æ¢æ¢",
      "style": "æ´»æ³¼å¥½å¥‡ï¼Œå–œæ¬¢è¯´'å“‡'å’Œ'å¥½å‰å®³'ï¼Œç»å¸¸ç”¨'æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹'å¼€å¤´",
      "voice_id": "zh_female_qingxin"
    },
    {
      "id": "mengmeng",
      "name": "èŒèŒ",
      "style": "æ¸©æŸ”ç»†è…»ï¼Œå–œæ¬¢è¯´'å®è´'ï¼Œç»å¸¸ç”¨'è®©æˆ‘æƒ³æƒ³'å¼€å¤´ï¼Œè¯­æ°”è½»æŸ”",
      "voice_id": "zh_female_wenrou"
    },
    {
      "id": "qiangqiang",
      "name": "å¼ºå¼º",
      "style": "å‹‡æ•¢æ­£ä¹‰ï¼Œå–œæ¬¢è¯´'å¤ªæ£’äº†'å’Œ'åŠ æ²¹'ï¼Œåƒå°è¶…äººä¸€æ ·é¼“åŠ±å­©å­",
      "voice_id": "zh_male_yangguang"
    }
  ]
}
```

### 3.3 æ¯æ—¥æ•…äº‹ç”Ÿæˆ Workflow

#### 3.3.1 å·¥ä½œæµèŠ‚ç‚¹è®¾è®¡

```
[å¼€å§‹]
    â”‚
    â–¼
[è¾“å…¥èŠ‚ç‚¹] æ¥æ”¶: child_id, date
    â”‚
    â–¼
[ä»£ç èŠ‚ç‚¹] è°ƒç”¨APIè·å–å½“æ—¥æ¢ç´¢äº‹ä»¶åˆ—è¡¨
    â”‚
    â–¼
[æ¡ä»¶åˆ¤æ–­] äº‹ä»¶æ•°é‡ > 0 ?
    â”‚
    â”œâ”€æ˜¯â”€â–¶ [å¤§æ¨¡å‹èŠ‚ç‚¹] ç”Ÿæˆæ¢ç´¢æ•…äº‹
    â”‚           â”‚
    â”‚           â–¼
    â”‚      [å¤§æ¨¡å‹èŠ‚ç‚¹] ç”Ÿæˆäº²å­å»ºè®®
    â”‚           â”‚
    â”‚           â–¼
    â”‚      [ä»£ç èŠ‚ç‚¹] ä¿å­˜å¹¶æ¨é€
    â”‚
    â””â”€å¦â”€â–¶ [ä»£ç èŠ‚ç‚¹] å‘é€"ä»Šå¤©ä¼‘æ¯"æç¤º
    â”‚
    â–¼
[ç»“æŸ]
```

#### 3.3.2 æ•…äº‹ç”Ÿæˆ Prompt

```
# ä»»åŠ¡
æ ¹æ®å­©å­ä»Šå¤©çš„æ¢ç´¢è®°å½•ï¼Œç”Ÿæˆä¸€ç¯‡æ¸©é¦¨çš„"æ¢ç´¢æ•…äº‹"ç»™å®¶é•¿é˜…è¯»ã€‚

# è¾“å…¥æ•°æ®
å­©å­æ˜µç§°ï¼š{{child_name}}
å¹´é¾„ï¼š{{child_age}}å²
ä»Šæ—¥æ¢ç´¢è®°å½•ï¼š
{{exploration_events}}

# è¾“å‡ºè¦æ±‚
1. ã€æ•…äº‹ã€‘ï¼ˆ150-200å­—ï¼‰
   - ä»¥ç¬¬ä¸‰äººç§°å™è¿°ï¼Œå­©å­æ˜¯ä¸»è§’
   - çªå‡ºå­©å­çš„è§‚å¯Ÿå’Œå‘ç°
   - è¯­æ°”æ¸©é¦¨ï¼Œåƒåœ¨è®²ä¸€ä¸ªå°æ•…äº‹
   - ç»“å°¾ç•™æœ‰æœŸå¾…æ„Ÿ

2. ã€äº²å­å¯¹è¯å»ºè®®ã€‘ï¼ˆ3ä¸ªé—®é¢˜+1ä¸ªä»»åŠ¡ï¼‰
   - 3ä¸ªå¼€æ”¾å¼é—®é¢˜ï¼Œå®¶é•¿å¯ä»¥ç›´æ¥é—®å­©å­
   - 1ä¸ªäº²å­å°ä»»åŠ¡ï¼Œ5åˆ†é’Ÿå†…å¯å®Œæˆ

# è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰
{
  "story": "æ•…äº‹å†…å®¹...",
  "questions": ["é—®é¢˜1", "é—®é¢˜2", "é—®é¢˜3"],
  "task": "äº²å­ä»»åŠ¡æè¿°"
}
```

---

## 4. API æ¥å£è®¾è®¡

### 4.1 æ¥å£æ€»è§ˆ

| æ¨¡å— | æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|------|
| è®¤è¯ | /api/v1/auth/login | POST | å®¶é•¿ç™»å½• |
| è®¤è¯ | /api/v1/auth/bind-child | POST | ç»‘å®šå­©å­è®¾å¤‡ |
| æ¢ç´¢ | /api/v1/explore/interact | POST | å­©å­ç«¯æ ¸å¿ƒäº¤äº’ |
| æ¢ç´¢ | /api/v1/explore/events | GET | æŸ¥è¯¢æ¢ç´¢äº‹ä»¶ |
| å®¶é•¿ | /api/v1/parent/timeline | GET | è·å–æ—¶é—´çº¿ |
| å®¶é•¿ | /api/v1/parent/story | GET | è·å–æ¯æ—¥æ•…äº‹ |
| å®¶é•¿ | /api/v1/parent/settings | PUT | æ›´æ–°è®¾ç½® |
| ç³»ç»Ÿ | /api/v1/upload | POST | æ–‡ä»¶ä¸Šä¼  |

### 4.2 æ ¸å¿ƒæ¥å£è¯¦æƒ…

#### 4.2.1 å­©å­ç«¯äº¤äº’æ¥å£

**POST /api/v1/explore/interact**

å­©å­ç«¯æ ¸å¿ƒäº¤äº’ï¼Œæ”¯æŒæ‹ç…§+è¯­éŸ³ã€‚

```typescript
// è¯·æ±‚
interface ExploreRequest {
  child_id: string;           // å­©å­ID
  session_id?: string;        // ä¼šè¯IDï¼ˆç»­èŠæ—¶ä¼ å…¥ï¼‰
  image_url?: string;         // å›¾ç‰‡OSSåœ°å€
  audio_url?: string;         // è¯­éŸ³OSSåœ°å€
  continue_signal?: boolean;  // æ˜¯å¦ç»§ç»­è¿½é—®
}

// å“åº”
interface ExploreResponse {
  code: number;
  data: {
    session_id: string;       // ä¼šè¯ID
    event_id: string;         // æ¢ç´¢äº‹ä»¶ID
    reply_text: string;       // AIå›å¤æ–‡æœ¬
    reply_audio_url: string;  // å›å¤è¯­éŸ³URL
    topic: string;            // è¯†åˆ«çš„ä¸»é¢˜
    should_continue: boolean; // æ˜¯å¦ç­‰å¾…è¿½é—®
  }
}
```

**å¤„ç†æµç¨‹ï¼š**
```
1. éªŒè¯è¯·æ±‚ â†’ 2. ä¸Šä¼ æ–‡ä»¶åˆ°OSS â†’ 3. ASRè¯­éŸ³è½¬æ–‡å­—
      â†“
4. ç»„è£…Cozeè¯·æ±‚ â†’ 5. è°ƒç”¨Coze Bot â†’ 6. TTSæ–‡å­—è½¬è¯­éŸ³
      â†“
7. ä¿å­˜æ¢ç´¢äº‹ä»¶ â†’ 8. è¿”å›å“åº”
```

#### 4.2.2 æ–‡ä»¶ä¸Šä¼ æ¥å£

**POST /api/v1/upload**

```typescript
// è¯·æ±‚ (multipart/form-data)
interface UploadRequest {
  file: File;                 // æ–‡ä»¶
  type: 'image' | 'audio';    // æ–‡ä»¶ç±»å‹
  child_id: string;           // å­©å­ID
}

// å“åº”
interface UploadResponse {
  code: number;
  data: {
    url: string;              // OSSè®¿é—®åœ°å€
    key: string;              // OSS key
  }
}
```

#### 4.2.3 å®¶é•¿æ—¶é—´çº¿æ¥å£

**GET /api/v1/parent/timeline**

```typescript
// è¯·æ±‚å‚æ•°
interface TimelineQuery {
  child_id: string;
  date?: string;              // YYYY-MM-DDï¼Œé»˜è®¤ä»Šå¤©
  page?: number;
  page_size?: number;
}

// å“åº”
interface TimelineResponse {
  code: number;
  data: {
    date: string;
    summary: {                // å½“æ—¥æ‘˜è¦
      total_events: number;
      top_topics: string[];
      keywords: string[];
    };
    events: ExploreEvent[];   // æ¢ç´¢äº‹ä»¶åˆ—è¡¨
    pagination: Pagination;
  }
}

interface ExploreEvent {
  id: string;
  time: string;
  image_url?: string;
  child_audio_url?: string;
  child_text?: string;
  ai_reply_text: string;
  ai_reply_audio_url: string;
  topic: string;
}
```

#### 4.2.4 æ¯æ—¥æ•…äº‹æ¥å£

**GET /api/v1/parent/story**

```typescript
// è¯·æ±‚å‚æ•°
interface StoryQuery {
  child_id: string;
  date?: string;              // YYYY-MM-DDï¼Œé»˜è®¤ä»Šå¤©
}

// å“åº”
interface StoryResponse {
  code: number;
  data: {
    id: string;
    date: string;
    story: string;            // æ¢ç´¢æ•…äº‹æ–‡æœ¬
    questions: string[];      // äº²å­é—®é¢˜å»ºè®®
    task: string;             // äº²å­ä»»åŠ¡
    event_count: number;      // å½“æ—¥äº‹ä»¶æ•°
    created_at: string;
  }
}
```

#### 4.2.5 å®¶é•¿è®¾ç½®æ¥å£

**PUT /api/v1/parent/settings**

```typescript
// è¯·æ±‚
interface SettingsRequest {
  child_id: string;
  settings: {
    photo_upload_enabled?: boolean;    // å¼€å¯æ‹ç…§ä¸Šä¼ 
    audio_save_enabled?: boolean;      // ä¿å­˜è¯­éŸ³
    quiet_hours?: {                    // é™éŸ³æ—¶æ®µ
      start: string;                   // HH:mm
      end: string;
    };
    daily_limit_minutes?: number;      // æ¯æ—¥æ—¶é•¿é™åˆ¶
    content_filter_level?: 'strict' | 'standard';  // å†…å®¹è¿‡æ»¤
    more_questions_mode?: boolean;     // æ›´çˆ±è¿½é—®æ¨¡å¼
    character_id?: string;             // é€‰æ‹©çš„è§’è‰²
  }
}
```

### 4.3 é”™è¯¯ç å®šä¹‰

| é”™è¯¯ç  | è¯´æ˜ |
|--------|------|
| 0 | æˆåŠŸ |
| 1001 | å‚æ•°é”™è¯¯ |
| 1002 | è®¤è¯å¤±è´¥ |
| 1003 | æƒé™ä¸è¶³ |
| 2001 | æ–‡ä»¶ä¸Šä¼ å¤±è´¥ |
| 2002 | æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ |
| 3001 | AIæœåŠ¡è°ƒç”¨å¤±è´¥ |
| 3002 | è¯­éŸ³æœåŠ¡è°ƒç”¨å¤±è´¥ |
| 4001 | å†…å®¹å®‰å…¨æ‹¦æˆª |
| 5001 | æœåŠ¡å†…éƒ¨é”™è¯¯ |

---

## 5. æ•°æ®åº“è®¾è®¡

### 5.1 ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   parents   â”‚â”€â”€1:Nâ”€â”€â”‚  children   â”‚â”€â”€1:Nâ”€â”€â”‚   events    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                     â”‚
                            â”‚                     â”‚
                           1:1                   N:1
                            â”‚                     â”‚
                            â–¼                     â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  settings   â”‚       â”‚  sessions   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   stories   â”‚       â”‚ characters  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è¡¨ç»“æ„è®¾è®¡

#### 5.2.1 å®¶é•¿è¡¨ (parents)

```sql
CREATE TABLE parents (
    id              VARCHAR(36) PRIMARY KEY,
    phone           VARCHAR(20) UNIQUE,
    wechat_openid   VARCHAR(64) UNIQUE,
    wechat_unionid  VARCHAR(64),
    nickname        VARCHAR(50),
    avatar_url      VARCHAR(500),
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at   TIMESTAMP
);

CREATE INDEX idx_parents_phone ON parents(phone);
CREATE INDEX idx_parents_openid ON parents(wechat_openid);
```

#### 5.2.2 å­©å­è¡¨ (children)

```sql
CREATE TABLE children (
    id              VARCHAR(36) PRIMARY KEY,
    parent_id       VARCHAR(36) NOT NULL REFERENCES parents(id),
    nickname        VARCHAR(50) NOT NULL,
    avatar_url      VARCHAR(500),
    birth_date      DATE,
    gender          VARCHAR(10),  -- male/female/unknown
    character_id    VARCHAR(36),  -- å½“å‰é€‰æ‹©çš„è§’è‰²
    device_id       VARCHAR(64),  -- ç»‘å®šçš„è®¾å¤‡ID
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active       BOOLEAN DEFAULT TRUE
);

CREATE INDEX idx_children_parent ON children(parent_id);
CREATE INDEX idx_children_device ON children(device_id);
```

#### 5.2.3 å­©å­è®¾ç½®è¡¨ (child_settings)

```sql
CREATE TABLE child_settings (
    id                      VARCHAR(36) PRIMARY KEY,
    child_id                VARCHAR(36) UNIQUE NOT NULL REFERENCES children(id),
    photo_upload_enabled    BOOLEAN DEFAULT TRUE,
    audio_save_enabled      BOOLEAN DEFAULT TRUE,
    quiet_hours_start       TIME,           -- é™éŸ³å¼€å§‹æ—¶é—´
    quiet_hours_end         TIME,           -- é™éŸ³ç»“æŸæ—¶é—´
    daily_limit_minutes     INT DEFAULT 60, -- æ¯æ—¥é™åˆ¶åˆ†é’Ÿæ•°
    content_filter_level    VARCHAR(20) DEFAULT 'standard',  -- strict/standard
    more_questions_mode     BOOLEAN DEFAULT FALSE,
    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 5.2.4 ä¼šè¯è¡¨ (sessions)

```sql
CREATE TABLE sessions (
    id              VARCHAR(36) PRIMARY KEY,
    child_id        VARCHAR(36) NOT NULL REFERENCES children(id),
    started_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ended_at        TIMESTAMP,
    event_count     INT DEFAULT 0,
    status          VARCHAR(20) DEFAULT 'active',  -- active/closed
    context         JSONB  -- å­˜å‚¨ä¼šè¯ä¸Šä¸‹æ–‡ä¾›Cozeä½¿ç”¨
);

CREATE INDEX idx_sessions_child ON sessions(child_id);
CREATE INDEX idx_sessions_status ON sessions(status);
```

#### 5.2.5 æ¢ç´¢äº‹ä»¶è¡¨ (explore_events)

```sql
CREATE TABLE explore_events (
    id                  VARCHAR(36) PRIMARY KEY,
    child_id            VARCHAR(36) NOT NULL REFERENCES children(id),
    session_id          VARCHAR(36) REFERENCES sessions(id),

    -- å­©å­è¾“å…¥
    image_url           VARCHAR(500),
    image_oss_key       VARCHAR(200),
    child_audio_url     VARCHAR(500),
    child_audio_oss_key VARCHAR(200),
    child_text          TEXT,           -- ASRè¯†åˆ«ç»“æœ

    -- AIå“åº”
    ai_reply_text       TEXT NOT NULL,
    ai_reply_audio_url  VARCHAR(500),
    ai_reply_audio_key  VARCHAR(200),

    -- å…ƒæ•°æ®
    topic               VARCHAR(50),    -- ä¸»é¢˜åˆ†ç±»
    keywords            TEXT[],         -- å…³é”®è¯æ•°ç»„
    coze_conversation_id VARCHAR(100),  -- Cozeä¼šè¯ID

    -- æ—¶é—´
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    duration_ms         INT,            -- å¤„ç†è€—æ—¶

    -- çŠ¶æ€
    is_deleted          BOOLEAN DEFAULT FALSE
);

CREATE INDEX idx_events_child ON explore_events(child_id);
CREATE INDEX idx_events_session ON explore_events(session_id);
CREATE INDEX idx_events_created ON explore_events(created_at);
CREATE INDEX idx_events_topic ON explore_events(topic);
CREATE INDEX idx_events_child_date ON explore_events(child_id, created_at);
```

#### 5.2.6 æ¯æ—¥æ•…äº‹è¡¨ (daily_stories)

```sql
CREATE TABLE daily_stories (
    id              VARCHAR(36) PRIMARY KEY,
    child_id        VARCHAR(36) NOT NULL REFERENCES children(id),
    story_date      DATE NOT NULL,

    -- æ•…äº‹å†…å®¹
    story_text      TEXT NOT NULL,
    questions       JSONB NOT NULL,     -- ["é—®é¢˜1", "é—®é¢˜2", "é—®é¢˜3"]
    task            TEXT NOT NULL,

    -- ç»Ÿè®¡
    event_count     INT DEFAULT 0,
    top_topics      TEXT[],

    -- çŠ¶æ€
    is_pushed       BOOLEAN DEFAULT FALSE,
    pushed_at       TIMESTAMP,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(child_id, story_date)
);

CREATE INDEX idx_stories_child ON daily_stories(child_id);
CREATE INDEX idx_stories_date ON daily_stories(story_date);
```

#### 5.2.7 è§’è‰²è¡¨ (characters)

```sql
CREATE TABLE characters (
    id              VARCHAR(36) PRIMARY KEY,
    name            VARCHAR(50) NOT NULL,
    description     TEXT,
    style           TEXT NOT NULL,      -- è¯´è¯é£æ ¼æè¿°
    voice_id        VARCHAR(50) NOT NULL, -- TTSéŸ³è‰²ID
    avatar_url      VARCHAR(500),
    is_active       BOOLEAN DEFAULT TRUE,
    sort_order      INT DEFAULT 0,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆå§‹æ•°æ®
INSERT INTO characters (id, name, style, voice_id, sort_order) VALUES
('xiaotantan', 'å°æ¢æ¢', 'æ´»æ³¼å¥½å¥‡ï¼Œå–œæ¬¢è¯´"å“‡"å’Œ"å¥½å‰å®³"', 'zh_female_qingxin', 1),
('mengmeng', 'èŒèŒ', 'æ¸©æŸ”ç»†è…»ï¼Œå–œæ¬¢è¯´"å®è´"ï¼Œè¯­æ°”è½»æŸ”', 'zh_female_wenrou', 2),
('qiangqiang', 'å¼ºå¼º', 'å‹‡æ•¢æ­£ä¹‰ï¼Œå–œæ¬¢è¯´"å¤ªæ£’äº†"å’Œ"åŠ æ²¹"', 'zh_male_yangguang', 3);
```

#### 5.2.8 ä½¿ç”¨ç»Ÿè®¡è¡¨ (usage_stats)

```sql
CREATE TABLE usage_stats (
    id              VARCHAR(36) PRIMARY KEY,
    child_id        VARCHAR(36) NOT NULL REFERENCES children(id),
    stat_date       DATE NOT NULL,

    -- ç»Ÿè®¡æ•°æ®
    event_count     INT DEFAULT 0,
    session_count   INT DEFAULT 0,
    total_duration_seconds INT DEFAULT 0,
    topic_counts    JSONB,  -- {"å®¶åº­ç‰©å“": 5, "åŠ¨æ¤ç‰©": 3}

    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(child_id, stat_date)
);

CREATE INDEX idx_stats_child_date ON usage_stats(child_id, stat_date);
```

---

## 6. è¯­éŸ³äº¤äº’æ–¹æ¡ˆ

### 6.1 æŠ€æœ¯é€‰å‹ï¼šç«å±±å¼•æ“è¯­éŸ³æœåŠ¡

é€‰æ‹©ç«å±±å¼•æ“çš„ç†ç”±ï¼š
- ä¸è±†åŒ…å¤§æ¨¡å‹åŒå±å­—èŠ‚ç”Ÿæ€ï¼Œé›†æˆæ–¹ä¾¿
- æä¾›å¤šç§é€‚åˆå„¿ç«¥çš„ä¸­æ–‡éŸ³è‰²
- æ”¯æŒæµå¼è¾“å‡ºï¼Œé™ä½å»¶è¿Ÿ
- ä»·æ ¼åˆç†ï¼Œé€‚åˆåˆ›ä¸šé¡¹ç›®

### 6.2 ASR è¯­éŸ³è¯†åˆ«

#### 6.2.1 æœåŠ¡é…ç½®

```yaml
æœåŠ¡: ç«å±±å¼•æ“è¯­éŸ³è¯†åˆ«
API: ä¸€å¥è¯è¯†åˆ« API
æ¨¡å‹: é€šç”¨ä¸­æ–‡æ¨¡å‹
é‡‡æ ·ç‡: 16000 Hz
éŸ³é¢‘æ ¼å¼: WAV / MP3
æœ€å¤§æ—¶é•¿: 60ç§’
```

#### 6.2.2 è°ƒç”¨ç¤ºä¾‹

```go
// ASRè¯·æ±‚
type ASRRequest struct {
    AppID      string `json:"app_id"`
    Token      string `json:"token"`
    AudioURL   string `json:"audio_url"`   // æˆ– base64
    Format     string `json:"format"`      // wav/mp3
    SampleRate int    `json:"sample_rate"` // 16000
}

// ASRå“åº”
type ASRResponse struct {
    Code    int    `json:"code"`
    Message string `json:"message"`
    Result  string `json:"result"`  // è¯†åˆ«æ–‡æœ¬
}
```

#### 6.2.3 å„¿ç«¥è¯­éŸ³ä¼˜åŒ–

é’ˆå¯¹3-6å²å„¿ç«¥è¯­éŸ³ç‰¹ç‚¹ï¼š
1. **å‰å¤„ç†**ï¼šé™å™ªã€å¢ç›Šè°ƒæ•´
2. **å®¹é”™å¤„ç†**ï¼šè¯†åˆ«ç»“æœä¸ºç©ºæ—¶ï¼Œæ’­æ”¾å¼•å¯¼è¯­"ä½ å¯ä»¥å†è¯´ä¸€éå—ï¼Ÿ"
3. **çº é”™è¡¥å…¨**ï¼šå¸¸è§ç«¥è¨€ç«¥è¯­æ˜ å°„è¡¨

```json
{
  "ç«¥è¨€æ˜ å°„": {
    "è¿™ä¸ªä»€ä¸ª": "è¿™æ˜¯ä»€ä¹ˆ",
    "ä¸ºä»€ä¹ˆå‘€ä¸ºä»€ä¹ˆ": "ä¸ºä»€ä¹ˆ",
    "å®ƒå®ƒå®ƒ": "å®ƒ"
  }
}
```

### 6.3 TTS è¯­éŸ³åˆæˆ

#### 6.3.1 æœåŠ¡é…ç½®

```yaml
æœåŠ¡: ç«å±±å¼•æ“è¯­éŸ³åˆæˆ
API: è¯­éŸ³åˆæˆ API
è¾“å‡ºæ ¼å¼: MP3
é‡‡æ ·ç‡: 24000 Hz
è¯­é€Ÿ: 0.85 (ç•¥æ…¢ï¼Œé€‚åˆå„¿ç«¥)
```

#### 6.3.2 æ¨èéŸ³è‰²

| éŸ³è‰²ID | åç§° | ç‰¹ç‚¹ | é€‚ç”¨è§’è‰² |
|--------|------|------|----------|
| zh_female_qingxin | æ¸…æ–°å¥³å£° | å¹´è½»æ´»æ³¼ | å°æ¢æ¢ |
| zh_female_wenrou | æ¸©æŸ”å¥³å£° | æ¸©æš–äº²åˆ‡ | èŒèŒ |
| zh_male_yangguang | é˜³å…‰ç”·å£° | æ­£èƒ½é‡ | å¼ºå¼º |

#### 6.3.3 è°ƒç”¨ç¤ºä¾‹

```go
// TTSè¯·æ±‚
type TTSRequest struct {
    AppID   string `json:"app_id"`
    Token   string `json:"token"`
    Text    string `json:"text"`
    VoiceID string `json:"voice_id"`
    Speed   float64 `json:"speed"`   // 0.85
    Volume  float64 `json:"volume"`  // 1.0
    Format  string `json:"format"`   // mp3
}

// TTSå“åº”
type TTSResponse struct {
    Code     int    `json:"code"`
    Message  string `json:"message"`
    AudioURL string `json:"audio_url"`  // æˆ–è¿”å›base64
}
```

### 6.4 è¯­éŸ³äº¤äº’æ—¶åºä¼˜åŒ–

```
ç”¨æˆ·æŒ‰ä¸‹å½•éŸ³ â”€â”€â”€â”€â”€â”
                 â”‚
                 â–¼
        [æœ¬åœ°å½•éŸ³ + VADæ£€æµ‹]
                 â”‚
        å½•éŸ³ç»“æŸ (æ¾æ‰‹/é™éŸ³)
                 â”‚
                 â–¼
        [ä¸Šä¼ éŸ³é¢‘åˆ°OSS]  â”€â”€â”€â”€ åŒæ—¶ â”€â”€â”€â”€ [ä¸Šä¼ å›¾ç‰‡åˆ°OSS]
                 â”‚
                 â–¼
        [ASRè¯†åˆ«] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â–¼
                            [è°ƒç”¨Coze Bot]
                                      â”‚
                                      â–¼
                            [TTSåˆæˆ] â”€â”€ æµå¼è¿”å›
                                      â”‚
                                      â–¼
                            [æ’­æ”¾è¯­éŸ³]
```

**ä¼˜åŒ–ç­–ç•¥ï¼š**
1. **å¹¶è¡Œä¸Šä¼ **ï¼šå›¾ç‰‡å’ŒéŸ³é¢‘åŒæ—¶ä¸Šä¼ 
2. **æµå¼TTS**ï¼šä½¿ç”¨æµå¼åˆæˆï¼Œè¾¹åˆæˆè¾¹æ’­æ”¾
3. **é¢„çƒ­è¿æ¥**ï¼šAPPå¯åŠ¨æ—¶é¢„å»ºç«‹é•¿è¿æ¥
4. **éŸ³é¢‘ç¼“å­˜**ï¼šå¸¸ç”¨å›å¤é¢„ç”ŸæˆéŸ³é¢‘

---

## 7. å®¶é•¿ç«¯å°ç¨‹åºæŠ€æœ¯æ–¹æ¡ˆ

### 7.1 æŠ€æœ¯é€‰å‹

```yaml
æ¡†æ¶: å¾®ä¿¡å°ç¨‹åºåŸç”Ÿ + Taro (è·¨ç«¯å¤‡é€‰)
UIåº“: Vant Weapp
çŠ¶æ€ç®¡ç†: MobX-miniprogram
ç½‘ç»œ: wx.request å°è£…
å›¾è¡¨: ECharts-for-weixin (ç»Ÿè®¡é¡µé¢)
```

### 7.2 é¡µé¢ç»“æ„

```
pages/
â”œâ”€â”€ index/              # é¦–é¡µï¼ˆæ—¶é—´çº¿ï¼‰
â”œâ”€â”€ story/              # æ¯æ—¥æ•…äº‹
â”œâ”€â”€ child/
â”‚   â”œâ”€â”€ list/          # å­©å­åˆ—è¡¨
â”‚   â”œâ”€â”€ detail/        # å­©å­è¯¦æƒ…
â”‚   â””â”€â”€ settings/      # å­©å­è®¾ç½®
â”œâ”€â”€ event/
â”‚   â””â”€â”€ detail/        # æ¢ç´¢äº‹ä»¶è¯¦æƒ…ï¼ˆå¯å›æ”¾ï¼‰
â”œâ”€â”€ profile/
â”‚   â”œâ”€â”€ index/         # æˆ‘çš„
â”‚   â””â”€â”€ settings/      # ç³»ç»Ÿè®¾ç½®
â””â”€â”€ auth/
    â””â”€â”€ login/         # ç™»å½•é¡µ
```

### 7.3 æ ¸å¿ƒé¡µé¢è®¾è®¡

#### 7.3.1 é¦–é¡µï¼ˆæ—¶é—´çº¿ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å­©å­å¤´åƒ] å°æ˜çš„æ¢ç´¢          â”‚
â”‚  2024-01-15                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ“– ä»Šæ—¥æ¢ç´¢æ•…äº‹ [æŸ¥çœ‹>]      â”‚â”‚
â”‚  â”‚ å°æ˜ä»Šå¤©å‘ç°äº†3ä¸ªæœ‰è¶£çš„ä¸œè¥¿..â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä»Šæ—¥æ‘˜è¦: æ¢ç´¢5æ¬¡ | åŠ¨æ¤ç‰©ã€å®¶åº­ç‰©å“â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  14:30  [å›¾ç‰‡] [æ’­æ”¾]           â”‚
â”‚  "å¦ˆå¦ˆï¼Œè¿™ä¸ªèŠ±æ˜¯ä»€ä¹ˆï¼Ÿ"          â”‚
â”‚  ä¸»é¢˜: åŠ¨æ¤ç‰©                    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  11:20  [å›¾ç‰‡] [æ’­æ”¾]           â”‚
â”‚  "ä¸ºä»€ä¹ˆè¦åˆ·ç‰™ï¼Ÿ"               â”‚
â”‚  ä¸»é¢˜: èº«ä½“å¥åº·                  â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ...                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.3.2 æ¯æ—¥æ•…äº‹é¡µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“– å°æ˜çš„æ¢ç´¢æ•…äº‹              â”‚
â”‚  2024å¹´1æœˆ15æ—¥                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  ä»Šå¤©å°æ˜å˜æˆäº†ä¸€ä¸ªå°å°æ¢é™©å®¶...  â”‚
â”‚  [æ•…äº‹æ­£æ–‡ï¼Œ150-200å­—]           â”‚
â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¬ å’Œå­©å­èŠèŠ                  â”‚
â”‚                                 â”‚
â”‚  1. ä½ ä»Šå¤©çœ‹åˆ°çš„èŠ±æ˜¯ä»€ä¹ˆé¢œè‰²çš„ï¼Ÿ  â”‚
â”‚  2. ä½ è§‰å¾—å°èœœèœ‚ä¸ºä»€ä¹ˆå–œæ¬¢èŠ±ï¼Ÿ    â”‚
â”‚  3. æ˜å¤©ä½ æƒ³å»å“ªé‡Œæ¢ç´¢ï¼Ÿ         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¯ äº²å­å°ä»»åŠ¡                  â”‚
â”‚                                 â”‚
â”‚  ä¸€èµ·å»é˜³å°çœ‹çœ‹è¿˜æœ‰ä»€ä¹ˆèŠ±åœ¨å¼€æ”¾   â”‚
â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [åˆ†äº«ç»™å®¶äºº]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.4 å…³é”®åŠŸèƒ½å®ç°

#### 7.4.1 éŸ³é¢‘æ’­æ”¾

```javascript
// æ’­æ”¾å­©å­/AIè¯­éŸ³
const audioContext = wx.createInnerAudioContext();

function playAudio(url) {
  audioContext.src = url;
  audioContext.play();
}

// æ’­æ”¾çŠ¶æ€ç®¡ç†
audioContext.onPlay(() => {
  this.setData({ isPlaying: true });
});
audioContext.onEnded(() => {
  this.setData({ isPlaying: false });
});
```

#### 7.4.2 æ¶ˆæ¯æ¨é€

```javascript
// è®¢é˜…æ¯æ—¥æ•…äº‹æ¨é€
async function subscribeStoryPush() {
  const tmplIds = ['æ•…äº‹æ¨é€æ¨¡æ¿ID'];
  const res = await wx.requestSubscribeMessage({
    tmplIds: tmplIds
  });
  return res[tmplIds[0]] === 'accept';
}
```

### 7.5 æ•°æ®å®‰å…¨

1. **ä¼ è¾“å®‰å…¨**ï¼šå…¨ç«™ HTTPS
2. **å­˜å‚¨å®‰å…¨**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
3. **è®¿é—®æ§åˆ¶**ï¼šå®¶é•¿åªèƒ½çœ‹è‡ªå·±å­©å­çš„æ•°æ®
4. **æ•°æ®åˆ é™¤**ï¼šæ”¯æŒä¸€é”®åˆ é™¤æ‰€æœ‰å­©å­æ•°æ®

---

## 8. å­©å­ç«¯ APP æŠ€æœ¯æ–¹æ¡ˆ

### 8.1 æŠ€æœ¯é€‰å‹

```yaml
æ¡†æ¶: Flutter 3.x
çŠ¶æ€ç®¡ç†: Riverpod
ç½‘ç»œ: Dio
éŸ³é¢‘å½•åˆ¶: record
éŸ³é¢‘æ’­æ”¾: just_audio
ç›¸æœº: camera
æœ¬åœ°å­˜å‚¨: shared_preferences + sqflite
```

### 8.2 æ ¸å¿ƒåŠŸèƒ½

#### 8.2.1 æ— å±æ¨¡å¼å®ç°

MVP é˜¶æ®µç”¨ APP æ¨¡æ‹Ÿæ— å±ç¡¬ä»¶ï¼š

```dart
// æ— å±æ¨¡å¼ï¼šé”å®šå±å¹•ï¼Œåªå“åº”æŒ‰é’®
class ScreenlessMode extends StatefulWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,  // é»‘å±
      body: GestureDetector(
        onTap: () => _handleTap(),      // ç‚¹å‡»æ‹ç…§
        onLongPress: () => _startRecording(),  // é•¿æŒ‰å½•éŸ³
        onLongPressEnd: (_) => _stopRecording(),
        child: Center(
          child: _isRecording
            ? PulsingIndicator()  // å½•éŸ³ä¸­åŠ¨ç”»
            : Icon(Icons.touch_app, color: Colors.white30),
        ),
      ),
    );
  }
}
```

#### 8.2.2 äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å­©å­ç«¯ APP ä¸»ç•Œé¢               â”‚
â”‚            ï¼ˆé»‘å±æ¨¡å¼ï¼‰                   â”‚
â”‚                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚                         â”‚        â”‚
â”‚     â”‚    ç‚¹å‡»å±å¹• = æ‹ç…§       â”‚        â”‚
â”‚     â”‚    é•¿æŒ‰å±å¹• = å½•éŸ³       â”‚        â”‚
â”‚     â”‚                         â”‚        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                         â”‚
â”‚     çŠ¶æ€æŒ‡ç¤ºï¼ˆå¾®å¼±å…‰æ•ˆï¼‰ï¼š               â”‚
â”‚     ğŸŸ¢ å°±ç»ª  ğŸ”´ å½•éŸ³ä¸­  ğŸ”µ å¤„ç†ä¸­       â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.2.3 æ ¸å¿ƒä»£ç ç»“æ„

```dart
// ä¸»äº¤äº’æ§åˆ¶å™¨
class ExploreController {
  final AudioRecorder _recorder;
  final CameraController _camera;
  final ApiClient _api;

  // æ‹ç…§å¹¶è¯†åˆ«
  Future<void> takePhotoAndAsk() async {
    // 1. æ‹ç…§
    final photo = await _camera.takePicture();

    // 2. æ’­æ”¾æç¤ºéŸ³"ä½ æƒ³é—®ä»€ä¹ˆï¼Ÿ"
    await _playPrompt('ask_prompt.mp3');

    // 3. å¼€å§‹å½•éŸ³
    await _startRecording();
  }

  // å‘é€è¯·æ±‚è·å–å›å¤
  Future<void> sendAndPlay(File? photo, File audio) async {
    // 1. ä¸Šä¼ æ–‡ä»¶
    final imageUrl = photo != null
      ? await _api.upload(photo, 'image')
      : null;
    final audioUrl = await _api.upload(audio, 'audio');

    // 2. è°ƒç”¨æ¢ç´¢æ¥å£
    final response = await _api.explore(
      imageUrl: imageUrl,
      audioUrl: audioUrl,
    );

    // 3. æ’­æ”¾AIå›å¤
    await _playAudio(response.replyAudioUrl);
  }
}
```

### 8.3 ç¦»çº¿æ”¯æŒ

```dart
// ç¦»çº¿é˜Ÿåˆ—ï¼šç½‘ç»œæ¢å¤åè‡ªåŠ¨ä¸Šä¼ 
class OfflineQueue {
  final Database _db;

  Future<void> enqueue(ExploreEvent event) async {
    await _db.insert('offline_queue', event.toMap());
  }

  Future<void> sync() async {
    final pending = await _db.query('offline_queue');
    for (final event in pending) {
      try {
        await _api.explore(event);
        await _db.delete('offline_queue', event.id);
      } catch (e) {
        break;  // ç½‘ç»œä»ä¸å¯ç”¨ï¼Œåœæ­¢åŒæ­¥
      }
    }
  }
}
```

---

## 9. æ¯æ—¥æ•…äº‹ç”Ÿæˆå·¥ä½œæµ

### 9.1 Coze å·¥ä½œæµè®¾è®¡

åœ¨ Coze å¹³å°åˆ›å»ºå®šæ—¶å·¥ä½œæµï¼š

```yaml
åç§°: æ¯æ—¥æ¢ç´¢æ•…äº‹ç”Ÿæˆ
è§¦å‘æ–¹å¼: å®šæ—¶è§¦å‘ (æ¯å¤© 21:00)
æ‰§è¡Œé¢‘ç‡: æ¯å¤©ä¸€æ¬¡
```

### 9.2 å·¥ä½œæµèŠ‚ç‚¹

```
[å®šæ—¶è§¦å‘ 21:00]
       â”‚
       â–¼
[ä»£ç èŠ‚ç‚¹: è·å–ä»Šæ—¥æ´»è·ƒå­©å­åˆ—è¡¨]
       â”‚
       â–¼
[å¾ªç¯èŠ‚ç‚¹: éå†æ¯ä¸ªå­©å­]
       â”‚
       â”œâ”€â”€â–¶ [ä»£ç èŠ‚ç‚¹: è·å–å­©å­å½“æ—¥æ¢ç´¢äº‹ä»¶]
       â”‚           â”‚
       â”‚           â–¼
       â”‚    [æ¡ä»¶åˆ¤æ–­: äº‹ä»¶æ•° > 0?]
       â”‚           â”‚
       â”‚     æ˜¯â”€â”€â”€â”€â”´â”€â”€â”€â”€å¦
       â”‚     â”‚          â”‚
       â”‚     â–¼          â–¼
       â”‚  [å¤§æ¨¡å‹èŠ‚ç‚¹]  [è·³è¿‡]
       â”‚  ç”Ÿæˆæ•…äº‹
       â”‚     â”‚
       â”‚     â–¼
       â”‚  [ä»£ç èŠ‚ç‚¹: ä¿å­˜æ•…äº‹]
       â”‚     â”‚
       â”‚     â–¼
       â”‚  [ä»£ç èŠ‚ç‚¹: æ¨é€é€šçŸ¥]
       â”‚
       â–¼
[ç»“æŸ]
```

### 9.3 ä»£ç èŠ‚ç‚¹å®ç°

#### 9.3.1 è·å–æ´»è·ƒå­©å­åˆ—è¡¨

```python
# Coze ä»£ç èŠ‚ç‚¹
import requests

def get_active_children(date):
    """è·å–ä»Šæ—¥æœ‰æ¢ç´¢äº‹ä»¶çš„å­©å­åˆ—è¡¨"""
    response = requests.get(
        f"{API_BASE}/internal/active-children",
        params={"date": date},
        headers={"Authorization": f"Bearer {INTERNAL_TOKEN}"}
    )
    return response.json()["data"]["children"]
```

#### 9.3.2 è·å–æ¢ç´¢äº‹ä»¶

```python
def get_child_events(child_id, date):
    """è·å–å­©å­å½“æ—¥çš„æ¢ç´¢äº‹ä»¶"""
    response = requests.get(
        f"{API_BASE}/internal/events",
        params={"child_id": child_id, "date": date},
        headers={"Authorization": f"Bearer {INTERNAL_TOKEN}"}
    )
    return response.json()["data"]["events"]
```

#### 9.3.3 ä¿å­˜æ•…äº‹å¹¶æ¨é€

```python
def save_and_push(child_id, date, story_data):
    """ä¿å­˜æ•…äº‹å¹¶æ¨é€ç»™å®¶é•¿"""
    # ä¿å­˜
    requests.post(
        f"{API_BASE}/internal/stories",
        json={
            "child_id": child_id,
            "date": date,
            "story": story_data["story"],
            "questions": story_data["questions"],
            "task": story_data["task"]
        },
        headers={"Authorization": f"Bearer {INTERNAL_TOKEN}"}
    )

    # æ¨é€ï¼ˆè°ƒç”¨å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ï¼‰
    requests.post(
        f"{API_BASE}/internal/push-story",
        json={"child_id": child_id, "date": date},
        headers={"Authorization": f"Bearer {INTERNAL_TOKEN}"}
    )
```

### 9.4 æ•…äº‹ç”Ÿæˆ Promptï¼ˆå¤§æ¨¡å‹èŠ‚ç‚¹ï¼‰

```
ä½ æ˜¯ä¸€ä½æ¸©æš–çš„æ•…äº‹è®²è¿°è€…ï¼Œä¸“é—¨ä¸ºå®¶é•¿è®°å½•å­©å­çš„æ¢ç´¢æ—…ç¨‹ã€‚

## è¾“å…¥æ•°æ®
å­©å­æ˜µç§°ï¼š{{child_name}}
å¹´é¾„ï¼š{{age}}å²
ä»Šæ—¥æ¢ç´¢è®°å½•ï¼š
{{events_summary}}

## ä»»åŠ¡
æ ¹æ®å­©å­ä»Šå¤©çš„æ¢ç´¢è®°å½•ï¼Œç”Ÿæˆï¼š
1. ä¸€ç¯‡150-200å­—çš„æ¸©é¦¨æ¢ç´¢æ•…äº‹
2. 3ä¸ªå®¶é•¿å¯ä»¥é—®å­©å­çš„å¼€æ”¾å¼é—®é¢˜
3. 1ä¸ª5åˆ†é’Ÿå†…å¯å®Œæˆçš„äº²å­å°ä»»åŠ¡

## å†™ä½œè¦æ±‚
- æ•…äº‹ä»¥ç¬¬ä¸‰äººç§°å™è¿°ï¼Œå­©å­æ˜¯ä¸»è§’
- çªå‡ºå­©å­çš„å¥½å¥‡å¿ƒå’Œè§‚å¯ŸåŠ›
- è¯­æ°”æ¸©é¦¨ã€å……æ»¡çˆ±æ„
- é¿å…è¯´æ•™ï¼Œå¼ºè°ƒæ¢ç´¢çš„ä¹è¶£

## è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰
{
  "story": "æ•…äº‹å†…å®¹",
  "questions": ["é—®é¢˜1", "é—®é¢˜2", "é—®é¢˜3"],
  "task": "äº²å­ä»»åŠ¡æè¿°"
}
```

---

## 10. å†…å®¹å®‰å…¨æ–¹æ¡ˆ

### 10.1 å¤šå±‚é˜²æŠ¤ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å†…å®¹å®‰å…¨é˜²æŠ¤å±‚                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬1å±‚ï¼šè¾“å…¥è¿‡æ»¤                                         â”‚
â”‚  - å›¾ç‰‡ï¼šè°ƒç”¨äº‘æœåŠ¡å›¾åƒå®¡æ ¸ API                          â”‚
â”‚  - è¯­éŸ³/æ–‡å­—ï¼šæ•æ„Ÿè¯åº“è¿‡æ»¤                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬2å±‚ï¼šPrompt çº¦æŸ                                      â”‚
â”‚  - System Prompt ä¸­æ˜ç¡®ç¦æ­¢å†…å®¹                         â”‚
â”‚  - é‡åˆ°æ•æ„Ÿå†…å®¹è½¬ç§»è¯é¢˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬3å±‚ï¼šè¾“å‡ºå®¡æ ¸                                         â”‚
â”‚  - AI å›å¤æ–‡æœ¬è¿‡æ•æ„Ÿè¯åº“                                 â”‚
â”‚  - å¼‚å¸¸å†…å®¹å‘Šè­¦ + äººå·¥å¤æ ¸                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬4å±‚ï¼šå®¶é•¿ç›‘ç£                                         â”‚
â”‚  - æ‰€æœ‰å¯¹è¯å¯å›æ”¾                                        â”‚
â”‚  - å¼‚å¸¸å†…å®¹æ¨é€å®¶é•¿                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 å›¾ç‰‡å®¡æ ¸

ä½¿ç”¨é˜¿é‡Œäº‘å†…å®¹å®‰å…¨ APIï¼š

```go
// å›¾ç‰‡å®¡æ ¸
func CheckImage(imageURL string) (*SafetyResult, error) {
    client := green.NewClient(...)

    result, err := client.ImageSyncScan([]string{imageURL}, []string{
        "porn",       // è‰²æƒ…
        "terrorism",  // æš´æ
        "ad",         // å¹¿å‘Š
        "qrcode",     // äºŒç»´ç 
        "live",       // ä¸è‰¯åœºæ™¯
    })

    if result.Suggestion == "block" {
        return &SafetyResult{Safe: false, Reason: result.Label}, nil
    }
    return &SafetyResult{Safe: true}, nil
}
```

### 10.3 æ•æ„Ÿè¯è¿‡æ»¤

```go
// æ•æ„Ÿè¯åº“ï¼ˆç¤ºä¾‹ï¼‰
var sensitiveWords = []string{
    // å„¿ç«¥ä¸å®œ
    "æ­»", "æ€", "è¡€", "é¬¼", "ææ€–",
    // ä¸è‰¯å¼•å¯¼
    "æ‰“äºº", "å·", "éª—",
    // éšç§å®‰å…¨
    "åœ°å€", "ç”µè¯", "å¯†ç ",
}

func FilterSensitive(text string) (string, bool) {
    for _, word := range sensitiveWords {
        if strings.Contains(text, word) {
            return "", false
        }
    }
    return text, true
}
```

---

## 11. æˆæœ¬ä¼°ç®—

### 11.1 äº‘æœåŠ¡æˆæœ¬ï¼ˆæŒ‰ 1000 DAU ä¼°ç®—ï¼‰

| æœåŠ¡ | å•ä»· | æ—¥ç”¨é‡ä¼°ç®— | æœˆæˆæœ¬ |
|------|------|-----------|--------|
| è±†åŒ… API (Coze) | Â¥0.008/åƒtokens | 50ä¸‡ tokens/å¤© | Â¥120 |
| ç«å±± ASR | Â¥0.006/15ç§’ | 5000æ¬¡/å¤© | Â¥900 |
| ç«å±± TTS | Â¥0.002/åƒå­—ç¬¦ | 100ä¸‡å­—ç¬¦/å¤© | Â¥60 |
| é˜¿é‡Œäº‘ OSS | Â¥0.12/GB | 10GB/å¤© | Â¥36 |
| é˜¿é‡Œäº‘ ECS | Â¥500/æœˆ | 2å° | Â¥1000 |
| å†…å®¹å®‰å…¨ | Â¥0.0025/å¼  | 5000å¼ /å¤© | Â¥375 |
| **æœˆåº¦æ€»è®¡** | | | **Â¥2,491** |

### 11.2 æˆæœ¬ä¼˜åŒ–ç­–ç•¥

1. **TTS ç¼“å­˜**ï¼šå¸¸ç”¨å›å¤é¢„ç”ŸæˆéŸ³é¢‘ï¼Œå‡å°‘ TTS è°ƒç”¨
2. **å›¾ç‰‡å‹ç¼©**ï¼šä¸Šä¼ å‰å‹ç¼©åˆ° 500KB ä»¥å†…
3. **æ‰¹é‡å¤„ç†**ï¼šæ•…äº‹ç”Ÿæˆæ‰¹é‡è°ƒç”¨ï¼Œé™ä½ API å¼€é”€
4. **é˜¶æ¢¯å®šä»·**ï¼šéšç”¨æˆ·å¢é•¿ï¼Œåå•†æ›´ä¼˜ä»·æ ¼

---

## 12. MVP å¼€å‘è®¡åˆ’

### 12.1 MVP èŒƒå›´

| åŠŸèƒ½ | MVP | åç»­è¿­ä»£ |
|------|-----|----------|
| å­©å­ç«¯æ‹ç…§+è¯­éŸ³ | âœ… | |
| AI å¯å‘å¼å¯¹è¯ | âœ… | |
| æ¢ç´¢äº‹ä»¶è®°å½• | âœ… | |
| å®¶é•¿æ—¶é—´çº¿ | âœ… | |
| æ¯æ—¥æ¢ç´¢æ•…äº‹ | âœ… | |
| äº²å­å»ºè®® | âœ… | |
| å¤šè§’è‰²åˆ‡æ¢ | 1ä¸ªé»˜è®¤è§’è‰² | 3ä¸ªè§’è‰² |
| ä½¿ç”¨æ—¶é•¿æ§åˆ¶ | âœ… | |
| æ•°æ®å¯¼å‡º/åˆ é™¤ | âœ… | |
| ç¦»çº¿æ”¯æŒ | âŒ | âœ… |
| å¤šå­©å­ç®¡ç† | âŒ | âœ… |
| æ•°æ®ç»Ÿè®¡åˆ†æ | âŒ | âœ… |

### 12.2 æŠ€æœ¯ä»»åŠ¡åˆ†è§£

**Phase 1: åŸºç¡€è®¾æ–½**
- [ ] æ­å»ºåç«¯æœåŠ¡æ¡†æ¶ (Go + Gin)
- [ ] é…ç½®æ•°æ®åº“ (PostgreSQL)
- [ ] é…ç½® OSS å­˜å‚¨
- [ ] æ¥å…¥ Coze å¹³å°ï¼Œåˆ›å»º Bot
- [ ] æ¥å…¥ç«å±±å¼•æ“è¯­éŸ³æœåŠ¡

**Phase 2: æ ¸å¿ƒåŠŸèƒ½**
- [ ] å®ç°æ¢ç´¢äº¤äº’æ¥å£
- [ ] å®ç°æ–‡ä»¶ä¸Šä¼ æ¥å£
- [ ] å­©å­ç«¯ APP å¼€å‘ (Flutter)
- [ ] å®¶é•¿ç«¯å°ç¨‹åºå¼€å‘

**Phase 3: æ•…äº‹ç”Ÿæˆ**
- [ ] åˆ›å»º Coze å®šæ—¶å·¥ä½œæµ
- [ ] å®ç°æ•…äº‹ç”Ÿæˆé€»è¾‘
- [ ] å®ç°å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ¨é€

**Phase 4: å®‰å…¨ä¸ä¼˜åŒ–**
- [ ] æ¥å…¥å†…å®¹å®‰å…¨å®¡æ ¸
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æµ‹è¯•ä¸ Bug ä¿®å¤

---

## 13. é™„å½•

### 13.1 ç¯å¢ƒå˜é‡é…ç½®

```bash
# æ•°æ®åº“
DB_HOST=localhost
DB_PORT=5432
DB_NAME=minidiscovery
DB_USER=postgres
DB_PASSWORD=xxx

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# é˜¿é‡Œäº‘ OSS
OSS_ACCESS_KEY_ID=xxx
OSS_ACCESS_KEY_SECRET=xxx
OSS_BUCKET=minidiscovery
OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com

# Coze
COZE_API_KEY=xxx
COZE_BOT_ID=xxx
COZE_WORKFLOW_ID=xxx

# ç«å±±å¼•æ“
VOLC_ACCESS_KEY=xxx
VOLC_SECRET_KEY=xxx
VOLC_APP_ID=xxx

# å†…å®¹å®‰å…¨
ALIYUN_GREEN_ACCESS_KEY=xxx
ALIYUN_GREEN_SECRET=xxx
```

### 13.2 å‚è€ƒæ–‡æ¡£

- Coze å¼€å‘æ–‡æ¡£: https://www.coze.cn/docs
- ç«å±±å¼•æ“è¯­éŸ³æœåŠ¡: https://www.volcengine.com/docs/6561
- é˜¿é‡Œäº‘ OSS: https://help.aliyun.com/document_detail/31817.html
- é˜¿é‡Œäº‘å†…å®¹å®‰å…¨: https://help.aliyun.com/document_detail/28417.html
- Flutter å®˜æ–¹æ–‡æ¡£: https://flutter.dev/docs
- å¾®ä¿¡å°ç¨‹åºå¼€å‘: https://developers.weixin.qq.com/miniprogram/dev/framework/
