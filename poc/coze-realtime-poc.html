<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coze Realtime API POC</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { color: #333; margin-bottom: 20px; }
    .section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .section h2 {
      font-size: 16px;
      color: #666;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-size: 14px;
      color: #555;
      margin-bottom: 5px;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #4A90D9;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #4A90D9;
      color: white;
    }
    .btn-primary:hover { background: #3A7BC8; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    .btn-danger:hover { background: #c0392b; }
    .btn-success {
      background: #27ae60;
      color: white;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status.disconnected { background: #fee; color: #c0392b; }
    .status.connecting { background: #fff3cd; color: #856404; }
    .status.connected { background: #d4edda; color: #155724; }
    .log-container {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .log-entry.info { color: #7ec8e3; }
    .log-entry.success { color: #98e4c9; }
    .log-entry.error { color: #ff6b6b; }
    .log-entry.event { color: #f5a962; }
    .log-entry .time { color: #666; margin-right: 8px; }
    .result-box {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    .result-box.success { background: #d4edda; color: #155724; }
    .result-box.error { background: #f8d7da; color: #721c24; }
    .result-box.warning { background: #fff3cd; color: #856404; }
    .checklist {
      list-style: none;
    }
    .checklist li {
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .checklist .icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .checklist .icon.pending { background: #eee; color: #999; }
    .checklist .icon.pass { background: #d4edda; color: #155724; }
    .checklist .icon.fail { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>Coze Realtime API POC</h1>

  <!-- 配置区 -->
  <div class="section">
    <h2>1. 配置</h2>
    <div class="form-group">
      <label>API Base URL</label>
      <select id="baseUrl">
        <option value="https://api.coze.cn">https://api.coze.cn (国内)</option>
        <option value="https://api.coze.com">https://api.coze.com (国际)</option>
      </select>
    </div>
    <div class="form-group">
      <label>Access Token (Personal Access Token)</label>
      <input type="password" id="accessToken" placeholder="pat_xxxxxxxx">
    </div>
    <div class="form-group">
      <label>Bot ID</label>
      <input type="text" id="botId" placeholder="7xxxxxxxxxxxxxxxxx">
    </div>
    <div class="form-group">
      <label>Voice ID (可选)</label>
      <input type="text" id="voiceId" placeholder="留空使用默认语音">
    </div>
  </div>

  <!-- 测试区 -->
  <div class="section">
    <h2>2. 测试</h2>
    <p style="margin-bottom: 15px;">
      连接状态: <span id="status" class="status disconnected">未连接</span>
    </p>
    <div class="btn-group">
      <button class="btn btn-primary" id="btnConnect" onclick="testConnect()">连接</button>
      <button class="btn btn-danger" id="btnDisconnect" onclick="testDisconnect()" disabled>断开</button>
      <button class="btn btn-success" id="btnMic" onclick="toggleMic()" disabled>开启麦克风</button>
    </div>
  </div>

  <!-- 验证清单 -->
  <div class="section">
    <h2>3. 验证清单</h2>
    <ul class="checklist">
      <li>
        <span class="icon pending" id="check1">-</span>
        <span>SDK 可在浏览器加载</span>
      </li>
      <li>
        <span class="icon pending" id="check2">-</span>
        <span>可获取麦克风权限</span>
      </li>
      <li>
        <span class="icon pending" id="check3">-</span>
        <span>可建立 RTC 连接</span>
      </li>
      <li>
        <span class="icon pending" id="check4">-</span>
        <span>可发送音频流</span>
      </li>
      <li>
        <span class="icon pending" id="check5">-</span>
        <span>可接收 AI 响应</span>
      </li>
    </ul>
  </div>

  <!-- 日志 -->
  <div class="section">
    <h2>4. 日志</h2>
    <div class="log-container" id="logContainer">
      <div class="log-entry info"><span class="time">[--:--:--]</span> 等待测试...</div>
    </div>
  </div>

  <!-- 结论 -->
  <div class="section">
    <h2>5. 结论</h2>
    <div id="conclusion">
      <p style="color: #666;">完成测试后将显示结论</p>
    </div>
  </div>

  <script type="module">
    // 动态导入 Coze Realtime SDK
    let RealtimeClient, EventNames, RealtimeUtils;
    let client = null;
    let micEnabled = false;

    // 日志函数
    function log(message, type = 'info') {
      const container = document.getElementById('logContainer');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="time">[${time}]</span> ${message}`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    }

    // 更新检查项
    function updateCheck(id, status) {
      const el = document.getElementById(id);
      el.className = `icon ${status}`;
      el.textContent = status === 'pass' ? '✓' : status === 'fail' ? '✗' : '-';
    }

    // 更新状态
    function updateStatus(status) {
      const el = document.getElementById('status');
      el.className = `status ${status}`;
      el.textContent = status === 'connected' ? '已连接' :
                       status === 'connecting' ? '连接中...' : '未连接';
    }

    // 初始化 SDK
    async function initSDK() {
      log('正在加载 @coze/realtime-api SDK...');
      try {
        const module = await import('https://esm.sh/@coze/realtime-api@latest');
        RealtimeClient = module.RealtimeClient;
        EventNames = module.EventNames;
        RealtimeUtils = module.RealtimeUtils;
        log('SDK 加载成功!', 'success');
        updateCheck('check1', 'pass');
        return true;
      } catch (e) {
        log(`SDK 加载失败: ${e.message}`, 'error');
        updateCheck('check1', 'fail');
        showConclusion('fail', 'SDK 无法在浏览器中加载，需要考虑替代方案');
        return false;
      }
    }

    // 测试连接
    window.testConnect = async function() {
      const baseURL = document.getElementById('baseUrl').value;
      const accessToken = document.getElementById('accessToken').value.trim();
      const botId = document.getElementById('botId').value.trim();
      const voiceId = document.getElementById('voiceId').value.trim();

      if (!accessToken || !botId) {
        log('请填写 Access Token 和 Bot ID', 'error');
        return;
      }

      // 检查 SDK
      if (!RealtimeClient) {
        const loaded = await initSDK();
        if (!loaded) return;
      }

      // 检查麦克风权限
      log('检查麦克风权限...');
      try {
        const permission = await RealtimeUtils.checkDevicePermission();
        if (permission.audio) {
          log('麦克风权限已获取', 'success');
          updateCheck('check2', 'pass');
        } else {
          log('麦克风权限被拒绝', 'error');
          updateCheck('check2', 'fail');
          return;
        }
      } catch (e) {
        log(`权限检查失败: ${e.message}`, 'error');
        updateCheck('check2', 'fail');
        return;
      }

      // 创建客户端
      log('创建 RealtimeClient...');
      updateStatus('connecting');

      try {
        client = new RealtimeClient({
          baseURL,
          accessToken,
          botId,
          voiceId: voiceId || undefined,
          debug: true,
          allowPersonalAccessTokenInBrowser: true,
          audioMutedDefault: true,
        });

        // 监听事件
        client.on(EventNames.CONNECTED, (e) => {
          log('连接成功!', 'success');
          updateCheck('check3', 'pass');
          updateStatus('connected');
          document.getElementById('btnConnect').disabled = true;
          document.getElementById('btnDisconnect').disabled = false;
          document.getElementById('btnMic').disabled = false;
        });

        client.on(EventNames.ERROR, (e) => {
          log(`错误: ${JSON.stringify(e)}`, 'error');
        });

        client.on(EventNames.ALL_SERVER, (e) => {
          log(`服务器事件: ${e.event_type || e.type || 'unknown'}`, 'event');

          // 检查是否收到 AI 响应
          if (e.event_type === 'conversation.message.delta' ||
              e.type === 'response.audio.delta') {
            updateCheck('check5', 'pass');
          }
        });

        client.on(EventNames.AUDIO_UNMUTED, () => {
          log('麦克风已开启', 'success');
          updateCheck('check4', 'pass');
        });

        // 连接
        log('正在连接...');
        await client.connect();

      } catch (e) {
        log(`连接失败: ${e.message}`, 'error');
        updateCheck('check3', 'fail');
        updateStatus('disconnected');
        showConclusion('fail', `连接失败: ${e.message}`);
      }
    };

    // 断开连接
    window.testDisconnect = async function() {
      if (client) {
        log('断开连接...');
        await client.disconnect();
        client = null;
        updateStatus('disconnected');
        document.getElementById('btnConnect').disabled = false;
        document.getElementById('btnDisconnect').disabled = true;
        document.getElementById('btnMic').disabled = true;
        log('已断开', 'info');

        // 检查结果
        const checks = ['check1', 'check2', 'check3', 'check4', 'check5'];
        const passed = checks.filter(id =>
          document.getElementById(id).classList.contains('pass')
        ).length;

        if (passed >= 4) {
          showConclusion('success', `验证通过 (${passed}/5)，Coze Realtime API 可用于本项目`);
        } else if (passed >= 2) {
          showConclusion('warning', `部分验证通过 (${passed}/5)，需要进一步测试`);
        } else {
          showConclusion('fail', `验证失败 (${passed}/5)，建议使用替代方案`);
        }
      }
    };

    // 切换麦克风
    window.toggleMic = async function() {
      if (!client) return;
      micEnabled = !micEnabled;
      await client.setAudioEnable(micEnabled);
      document.getElementById('btnMic').textContent = micEnabled ? '关闭麦克风' : '开启麦克风';
      log(micEnabled ? '麦克风已开启，请说话...' : '麦克风已关闭', 'info');
    };

    // 显示结论
    function showConclusion(type, message) {
      const el = document.getElementById('conclusion');
      el.innerHTML = `<div class="result-box ${type}">${message}</div>`;
    }

    // 页面加载时初始化
    window.addEventListener('load', async () => {
      log('POC 页面已加载');
      await initSDK();
    });
  </script>
</body>
</html>
